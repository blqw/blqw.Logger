<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>查看日志</title>

    <link href="http://g.alicdn.com/bui/bui/1.1.17/css/bs3/dpl-min.css" rel="stylesheet">
    <link href="http://g.alicdn.com/bui/bui/1.1.17/css/bs3/bui-min.css" rel="stylesheet">
    <style>
        table td, table th { line-height: 2em; }
        .bui-button-number { display: none; }
        .bui-bar-item.disabled { display: none; }
        .bui-grid .bui-pagingbar input.bui-pb-page[name=inputItem] { width: 80px; }
        td { cursor: pointer; }
        .highlight { background-color: aqua; }

        span.category { text-align: center; font-weight: bold; }
        #sholog { margin: 0; padding: 0; }
            #sholog li { word-break: break-all; word-wrap: break-word; display: block; line-height: 20px; padding: 10px; }
                #sholog li:nth-child(2n+1) { background-color: #DEDEDE; }
                #sholog li:nth-child(2n) { background-color: #fffbfb; }
        .am-text-primary { color: #0e90d2; }
        .am-text-success { color: #5eb95e; }
        @media screen and (max-width:768px) {
            #sholog li { overflow-x: hidden; }
                #sholog li .category { text-align: left; }
        }
    </style>
</head>
<body>
    <div class="demo-content">

        <div id="grid" style="width:95%;margin:auto">
            <div class="panel-title" style="line-height:3em;margin-top:20px">
                <input id="file_logs" type="file" multiple="multiple" />
                <span>&nbsp;&nbsp;&nbsp;</span>
                <input id="searchKey" style="width:240px" type="text">
                <span>&nbsp;&nbsp;&nbsp;</span>
                <button id="btnSearch" type="button" class="button button-primary">查询</button>
            </div>
        </div>

        <script type="text/javascript" src="http://apps.bdimg.com/libs/jquery/1.8.1/jquery.min.js"></script>
        <script src="http://g.alicdn.com/bui/bui/1.1.21/seed-min.js"></script>
        <script src="http://g.alicdn.com/bui/bui/1.1.21/grid.js"></script>
        <script src="http://g.alicdn.com/bui/bui/1.1.21/data.js"></script>

        <div id="log_detail" style="display: block;height: 500px">
            <h5 style="padding:0 20px;" id="caption">UID：{UID}<br />时间：{Time}</h5>
            <!--<ul id="sholog" style="list-style:none;">
                <li style="">
                    <span class="am-text-success">[{time}]</span>
                    <span class="am-text-{levelstyle}">[{level}]</span>
                    <span class="category">{category}</span> {message}
                    {text}
                    {callstack}
                    {format}
                </li>
            </ul>-->
            <ul id="sholog" style="list-style:none;">

                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">WebApi.RequestID</span> REQUEST-blqw-spc-X98-G-4UXW46-F5I5AH



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">system.request_log_id</span> LOG-blqw-spc-X98-G-TB4T7B-F5I5F7



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;"></span> Top.Core&nbsp;last&nbsp;updated&nbsp;time&nbsp;2016-11-07&nbsp;10:05:28



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">HostName</span> blqw-spc



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">HostAddresses</span>



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">RealIP</span> ::1



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">*IP*</span> ::1



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">*Url*</span> http://localhost:52313/oauth/exit



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">ContentType</span>



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">UserAgent</span> Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;10.0;&nbsp;WOW64)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/49.0.2623.22&nbsp;Safari/537.36&nbsp;SE&nbsp;2.X&nbsp;MetaSr&nbsp;1.0



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">AppCode</span> 无



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">Agent</span> 无



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">Cookie.SessionID</span> 38e0ca9867ae47328960ed259565f4dc.20491018



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">SessionID</span> 38e0ca9867ae47328960ed259565f4dc.20491018



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">WebApi&nbsp;Timing</span> 0.2378&nbsp;ms



                </li>
                <li style="" data-item="">
                    <span class="am-text-success">[10:07:15.545]</span>
                    <span class="am-text-primary">[调试]</span>
                    <span class="category" style="display: inline-block; width: 186px;">WebApi&nbsp;Log</span> Request&nbsp;End



                </li>
            </ul>
        </div>
    </div>


    <!--时间处理-->
    <script>
            //其他功能
            //格式化时间
            var ___DateToString = Date.prototype.toString;
            Date.prototype.toString = function (format) {
                if (format === undefined) {
                    return ___DateToString.apply(this);
                }
                if (format === null) {
                    format = "yyyy-MM-dd HH:mm:ss";
                }

                format = format.replace(/yyyy/g, this.getFullYear());
                format = format.replace(/yyy/g, this.getYear());
                format = format.replace(/yy/g, this.getFullYear().toString().slice(-2));

                if (format.indexOf('mi') >= 0) {
                    format = format.replace(/mi/g, this.getMilliseconds().toString());
                }

                if (format.indexOf('M') >= 0) {
                    var M = (this.getMonth() + 1).toString();
                    format = format.replace(/MM/g, ("0" + M).slice(-2));
                    format = format.replace(/M/g, M);
                }

                if (format.indexOf('ddd') >= 0) {
                    var xq = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];
                    format = format.replace(/ddd/g, xq[this.getDay()]);
                }

                if (format.indexOf('d') >= 0) {
                    var d = this.getDate().toString();
                    format = format.replace(/dd/g, ("0" + d).slice(-2));
                    format = format.replace(/d/g, d);
                }


                if (format.indexOf('h') >= 0 || format.indexOf('H') >= 0) {
                    var h = this.getHours().toString();
                    format = format.replace(/HH/g, ("0" + h).slice(-2));
                    format = format.replace(/H/g, h);
                    h = h % 12;
                    format = format.replace(/hh/g, ("0" + h).slice(-2));
                    format = format.replace(/h/g, h);
                }

                if (format.indexOf('m') >= 0) {
                    var m = this.getMinutes().toString();
                    format = format.replace(/mm/g, ("0" + m).slice(-2));
                    format = format.replace(/m/g, m);
                }

                if (format.indexOf('s') >= 0) {
                    var s = this.getSeconds().toString();
                    format = format.replace(/ss/g, ("0" + s).slice(-2));
                    format = format.replace(/s/g, m);
                }

                if (format.indexOf('f') >= 0) {
                    var f = this.getMilliseconds().toString();
                    format = format.replace(/fff/g, ("000" + f).slice(-3));
                    format = format.replace(/ff/g, ("000" + f).slice(-3).substr(0, 2));
                    format = format.replace(/f/g, ("000" + f).slice(-3).substr(0, 1));
                }
                //.getMilliseconds()

                return format;
            };
            //时间加减
            Date.prototype.add = function (type, value) {
                this.checkNumber(value);
                var date = new Date(this);
                switch (type) {
                case 'y':
                case 'Y':
                    date.setYear(this.getYear() + value);
                    break;
                case 'M':
                    date.setMonths(this.getMonths() + value);
                    break;
                case 'd':
                case 'D':
                    date.setDate(this.getDate() + value);
                    break;
                case 'h':
                case 'H':
                    date.setHours(this.getHours() + value);
                    break;
                case 'm':
                    date.setMinutes(this.getMinutes() + value);
                    break;
                case 'S':
                case 's':
                    date.setSeconds(this.getSeconds() + value);
                    break;
                case 'f':
                    date.setMilliseconds(this.getMilliseconds() + value);
                    break;
                default:
                    throw Error("type只能是:y,Y,M,d,D,h,H,m,s,S,f");
                }
                return date;
            };

            Date.prototype.addDays = function (value) { return this.add("d", value); };
            Date.prototype.addHours = function (value) { return this.add("h", value); };
            Date.prototype.addMilliseconds = function (value) { return this.add("f", value); };
            Date.prototype.addMinutes = function (value) { return this.add("m", value); };
            Date.prototype.addMonths = function (value) { return this.add("M", value); };
            Date.prototype.addSeconds = function (value) { return this.add("s", value); };
            Date.prototype.addYears = function (value) { return this.add("y", value); };
    </script>

    <!--本地文件处理-->
    <script>
            function upload(input, callback) {
                //支持chrome IE10
                if (window.FileReader) {
                    var index = 0;
                    var text = [];
                    (function () {
                        text.push(this.result);
                        if (index === input.files.length) {
                            text.shift();
                            callback(text.join());
                        } else {
                            var reader = new FileReader();
                            reader.onload = arguments.callee;
                            reader.readAsText(input.files[index]);
                            index++;
                        }
                    })();

                } //支持IE 7 8 9 10
                else if (typeof window.ActiveXObject != 'undefined') {
                    var xmldom = new ActiveXObject("Microsoft.XMLDOM");
                    xmldom.async = false;
                    xmldom.load(input.value);
                    callback(xmldom.xml);
                } //支持FF
                else if (document.implementation && document.implementation.createDocument) {
                    var xmlDoc = document.implementation.createDocument("", "", null);
                    xmlDoc.async = false;
                    xmlDoc.load(input.value);
                    callback(xmlDoc.xml);
                } else {
                    alert('请换一个浏览器');
                }
            }
    </script>

    <!--日志格式处理-->
    <script>
            function ParseLogs(text) {
                var lines = text.split(/[\n\r]+/g);
                var list = [];
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (line == null || $.trim(line).length === 0) {
                        continue;
                    }
                    var arr = line.split(",");
                    var log = {
                        Time: arr[0],
                        UID: arr[1],
                        LogLevel: parseInt(arr[2]),
                        Module: arr[3],
                        Details: ParseDetails(arr[4])
                    };
                    log.Summary = GetSummary(log);
                    var search = $.trim($("#searchKey").val());
                    if (search.length > 0) {
                        var regexp = new RegExp("(" + search + ")", "gmi");
                        var l = log.Summary.length;
                        log.Summary = log.Summary.replace(regexp, "<b class='highlight'>$1</b>");
                        if (l === log.Summary.length) {
                            continue;
                        }
                    }
                    list.push(log);
                }
                list.sort(function (a, b) { return Date.parse(b.Time) - Date.parse(a.Time); });
                return list;
            }

            function GetSummary(log) {
                var search = $.trim($("#searchKey").val());
                var lines = [];
                for (var i = 0; i < log.Details.length; i++) {
                    var d = log.Details[i];
                    if ((/^[*].+[*]$/g).test(d.category)) {
                        lines.push(d.message);
                    } else if (search.length > 0) {
                        var regexp = new RegExp(search, "gi");
                        if (regexp.test(d.category)) {
                            lines.push(d.category);
                        } else if (regexp.test(d.message)) {
                            lines.push(d.message);
                        } else if (regexp.test(d.category)) {
                            lines.push(d.callstack);
                        } else if (regexp.test(d.text)) {
                            lines.push(d.text);
                        }
                    }
                }
                if (lines.length === 0) {
                    return "无摘要";
                }
                return lines.join("<br />");
            }

            function ParseDetails(text) {
                text = decodeURIComponent(text);
                var lines = text.split(/[\n\r]+/g);
                var list = [];
                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];
                    if (line == null || $.trim(line).length === 0) {
                        continue;
                    }
                    var arr = line.split(",");
                    var log = {
                        time: arr[0],
                        level: parseInt(arr[1]),
                        category: decodeURIComponent(arr[2]),
                        message: decodeURIComponent(arr[3]),
                        callstack: decodeURIComponent(arr[4]),
                        text: decodeURIComponent(arr[5])
                    };
                    list.push(log);
                }
                return list;
            }
    </script>

    <!--页面处理-->
    <script type="text/javascript">
        BUI.use(['bui/grid', 'bui/data', 'bui/overlay'], function (Grid, Data, Overlay) {

            var Grid = Grid,
                Store = Data.Store,
                columns = [
                    { title: '时间', dataIndex: 'Time', elCls: 'center', width: 150 },
                    { title: '等级', dataIndex: 'LogLevel', elCls: 'center', width: 100 },
                    { title: '摘要', dataIndex: 'Summary', width: '70%' },
                    { name: 'UID', title: 'UID', dataIndex: 'UID', width: '2%', visible: false }
                ];

            var store = new Store({

            });
            var grid = new Grid.Grid({
                render: '#grid',
                columns: columns,
                loadMask: true, //加载数据时显示屏蔽层
                store: store
            });
            store.on('exception', function (data) {
                BUI.Message.Alert(data.error);
            });
            grid.render();

            var load = function () {
                upload($("#file_logs")[0],
                    function (text) {
                        var data = ParseLogs(text);
                        store.get('proxy').set('data', data);
                        var logs = {};
                        for (var i = 0; i < data.length; i++) {
                            var row = data[i];
                            logs[row.UID] = row;
                            row.LogLevel = ['', '异常', '警告', '提示', '调试'][row.LogLevel];
                        }
                        window.Logs = logs;
                        store.load();
                    });
            }

            $("#file_logs").change(load);
            $("#btnSearch").click(load);


            grid.on('rowclick', function (data) {
                var uid = $(data.row).find("td[data-column-field=UID]").text();
                if (uid == null || uid.length === 0) {
                    return;
                }

                var detail = $("#log_detail > *").clone().wrapAll("<div />");

                var dialog = new Overlay.Dialog({
                    width: "90%",
                    height: $(window).height() * 0.9,
                    elCls: 'custom-dialog',
                    bodyContent: '<iframe src="details.html?uid=' + uid + '" width="100%" height="100%" frameborder="0"></iframe>',
                    buttons: [],
                    mask: true
                });
                dialog.show();
            });
            //store.load();
        });

        function queryString(name) {
            var rex = new RegExp("[?&]\s*" + name + "\s*=([^&$#]*)", "i");
            var r = rex.exec(location.search);
            if (r && r.length === 2)
                return decodeURIComponent(r[1]);
        }
    </script>

    <!-- script end -->
</body>
</html>